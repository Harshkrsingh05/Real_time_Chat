rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isParticipant(participants) {
      return request.auth.uid in participants;
    }
    
    function hasValidUserData() {
      return request.auth.uid == userId &&
             request.auth.token.email == request.resource.data.email;
    }
    
    function hasValidUserUpdateData() {
      return request.auth.uid == userId &&
             (request.resource.data.email == resource.data.email || 
              request.auth.token.email == request.resource.data.email);
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data and data of users they chat with
      allow read: if isAuthenticated() && (
        isOwner(userId) || 
        exists(/databases/$(database)/documents/chatRooms/$(userId))
      );
      
      // Users can only create their own profile
      allow create: if isAuthenticated() && 
                   isOwner(userId) && 
                   request.resource.data.email == request.auth.token.email;
      
      // Users can update their own profile
      allow update: if isAuthenticated() && 
                   isOwner(userId);
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Chat rooms collection
    match /chatRooms/{chatRoomId} {
      // Participants can read the chat room
      allow read: if isAuthenticated() && 
                 isParticipant(resource.data.participants);
      
      // Authenticated users can create chat rooms
      allow create: if isAuthenticated() && 
                   request.auth.uid == request.resource.data.createdBy &&
                   request.auth.uid in request.resource.data.participants;
      
      // Participants can update chat room (for last message, etc.)
      allow update: if isAuthenticated() && 
                   isParticipant(resource.data.participants) &&
                   // Ensure participants list isn't maliciously modified
                   request.resource.data.participants.hasAll(resource.data.participants);
      
      // Only creator can delete (for group chats)
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.createdBy);
    }
    
    // Messages collection
    match /messages/{messageId} {
      // Users can read messages from chat rooms they participate in
      allow read: if isAuthenticated() && 
                 exists(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)) &&
                 request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)).data.participants;
      
      // Users can create messages in chat rooms they participate in
      allow create: if isAuthenticated() && 
                   request.auth.uid == request.resource.data.senderId &&
                   exists(/databases/$(database)/documents/chatRooms/$(request.resource.data.chatRoomId)) &&
                   request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(request.resource.data.chatRoomId)).data.participants;
      
      // Users can update their own messages (for edits, reactions, etc.)
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.senderId) || 
                    // Allow updates for reactions and read receipts
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'readBy']));
      
      // Users can delete their own messages
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.senderId);
    }
    
    // File uploads collection
    match /fileUploads/{fileId} {
      // Users can read files from chat rooms they participate in
      allow read: if isAuthenticated() && 
                 exists(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)) &&
                 request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)).data.participants;
      
      // Users can create file uploads
      allow create: if isAuthenticated() && 
                   isOwner(request.resource.data.uploadedBy);
      
      // Users can update their own file uploads
      allow update: if isAuthenticated() && 
                   isOwner(resource.data.uploadedBy);
      
      // Users can delete their own file uploads
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.uploadedBy);
    }
    
    // Typing indicators collection (temporary data)
    match /typingIndicators/{indicatorId} {
      // Users can read typing indicators for chat rooms they participate in
      allow read: if isAuthenticated() && 
                 exists(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)) &&
                 request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(resource.data.chatRoomId)).data.participants;
      
      // Users can create/update their own typing indicators
      allow create, update: if isAuthenticated() && 
                           isOwner(request.resource.data.userId);
      
      // Users can delete their own typing indicators
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.userId);
    }
  }
}

// Storage rules for file uploads
service firebase.storage {
  match /b/{bucket}/o {
    // Chat room files
    match /chatRooms/{chatRoomId}/files/{fileId} {
      // Users can read files from chat rooms they participate in
      allow read: if request.auth != null &&
                 exists(/databases/(default)/documents/chatRooms/$(chatRoomId)) &&
                 request.auth.uid in get(/databases/(default)/documents/chatRooms/$(chatRoomId)).data.participants;
      
      // Users can upload files to chat rooms they participate in
      allow write: if request.auth != null &&
                  exists(/databases/(default)/documents/chatRooms/$(chatRoomId)) &&
                  request.auth.uid in get(/databases/(default)/documents/chatRooms/$(chatRoomId)).data.participants &&
                  // Limit file size to 50MB
                  request.resource.size < 50 * 1024 * 1024;
    }
    
    // User profile pictures
    match /users/{userId}/avatar {
      // Users can read any avatar
      allow read: if request.auth != null;
      
      // Users can only upload their own avatar
      allow write: if request.auth != null && 
                  request.auth.uid == userId &&
                  // Limit file size to 5MB
                  request.resource.size < 5 * 1024 * 1024;
    }
  }
}